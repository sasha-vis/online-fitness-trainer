#!/bin/bash
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "ğŸ¯ Running pre-commit checks..."

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ”Ğ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
CHANGED_FILES=$(git diff --cached --name-only)

if [ -z "$CHANGED_FILES" ]; then
    echo "ğŸ“ No staged changes found"
    exit 0
fi

echo "ğŸ“ Changed files:"
echo "$CHANGED_FILES"

# Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼
echo "ğŸ¨ Formatting code..."
npm run format || exit 1

# ĞŸĞ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¾Ğ¼
echo "ğŸ” Running linter..."

CLIENT_CHANGED=$(echo "$CHANGED_FILES" | grep "client/" || true)
SERVER_CHANGED=$(echo "$CHANGED_FILES" | grep "server/" || true)

if [ -n "$CLIENT_CHANGED" ]; then
    echo "ğŸ” Linting client..."
    npm run lint:client || exit 1

    echo "ğŸ“‹ Type checking client..."
    npm run type-check:client || exit 1
fi

if [ -n "$SERVER_CHANGED" ]; then
    echo "ğŸ” Linting server..."
    npm run lint:server || exit 1

    echo "ğŸ“‹ Type checking server..."
    npm run type-check:server || exit 1
fi

git add .

echo "âœ… Pre-commit checks passed!"