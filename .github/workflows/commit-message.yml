name: Check Commit Messages

on:
    pull_request:
        branches: [develop, main]
        types: [opened, synchronize]

jobs:
    check-commits:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Validate commit messages
              run: |
                  echo "üîç Checking commit messages in PR..."

                 
                  COMMITS=$(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

                  echo "Found commits:"
                  echo "$COMMITS"
                  echo "---"

                  INVALID_COUNT=0
                  while IFS= read -r commit; do
                    if [ -n "$commit" ]; then

                      # –ò–ì–ù–û–†–ò–†–£–ï–ú –í–°–ï —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã
                      if echo "$commit" | grep -qE "^(Merge (pull request|branch|remote-tracking|commit)|Revert )"; then
                        echo "‚úÖ Skipping system commit: '$commit'"
                        continue
                      fi

                      echo "Checking: '$commit'"
                      if [[ "$commit" =~ ^#[0-9]+[[:space:]](feat|fix|docs|style|refac|test|chore|perf)(\([a-z]+\))?:[[:space:]].+ ]]; then
                        echo "‚úÖ Valid"
                      else
                        echo "‚ùå Invalid"
                        INVALID_COUNT=$((INVALID_COUNT + 1))
                      fi
                    fi
                  done <<< "$COMMITS"

                  if [ $INVALID_COUNT -gt 0 ]; then
                    echo "::error ::Found $INVALID_COUNT invalid commit message(s)"
                    echo "Commit must follow: #[task-number] type[(scope)]: description"
                    exit 1
                  fi

                  echo "‚úÖ All commit messages are valid!"
